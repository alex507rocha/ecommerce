chamados_encerrados: 
SQL 
SELECT
-- tck.id,
CASE
  WHEN disc.id=7 THEN DATE_FORMAT(eventos.value_date, '%Y-%m')
  ELSE DATE_FORMAT(ts.data_encerramento_ticket, '%Y-%m')
END AS "Período",
tck.tn AS "Numero Chamado",
tck.create_time AS "Data/Hora de Criacao",
ts.data_classificacao_ticket AS "Data/Hora de Classificação",
tipochamado.origem AS "Origem da Abertura",
tipochamado.tipo_chamado AS "Meio de Abertura",
CONCAT(us.first_name, ' ', us.last_name) AS "Nome Técnico",
us.title AS email,
-- dfvtempoatend.value_text AS "Tempo em Atendimento (Min)",



CASE
  WHEN disc.id IN (8,13) AND  ts.data_classificacao_ticket IS NOT NULL 
  THEN TIMESTAMPDIFF(MINUTE,tck.create_time, ts.data_classificacao_ticket) 
  WHEN disc.id IN (8,13) THEN 0
  ELSE NULL 
END AS "Tempo Classificação (Min)",
sla.comments AS "SLA de Classificação",
CASE -- Tem necessidade de pegar o tempo no item do catálogo
  WHEN (TIMESTAMPDIFF(MINUTE,tck.create_time, ts.data_classificacao_ticket)<=sla.comments AND disc.id IN (8,13))
  OR (ts.data_classificacao_ticket is NULL AND disc.id IN (8,13)) 
  THEN "Classificado Dentro do Prazo"
  WHEN (TIMESTAMPDIFF(MINUTE,tck.create_time, ts.data_solutiontime_ticket)>sla.comments AND disc.id IN (8,13))
  THEN "Classificado Fora do Prazo"
  ELSE 'INDETERMINADO'
END AS "Status Classificacao Chamado",
CASE
  WHEN disc.id=7 THEN TIMESTAMPDIFF(MINUTE,tck.create_time, eventos.value_date)
  WHEN disc.id=9 THEN TIMESTAMPDIFF(MINUTE,tck.create_time, ts.data_encerramento_ticket)
  ELSE tempoatend.tempo_atendimento
END AS "Tempo em Atendimento (Min)",
sla.solution_time AS "SLA de Atendimento",
CASE  -- Tem necessidade de pegar o tempo no item do catálogo
  WHEN sla.solution_time <= 240 THEN 'Crítico'
  ELSE 'Não Crítico'
END AS "Criticidade",
serv.create_time AS "Data do Catálogo",
CASE  -- Tem necessidade de pegar o tempo no item do catálogo
  WHEN tck.create_time >= '2023-02-04 00:00:00' THEN 'Novo'
  ELSE 'Antigo'
END AS "Tipo SLA",


CASE  -- Tem necessidade de pegar o tempo no item do catálogo
  WHEN disc.id=7 AND  TIMESTAMPDIFF(MINUTE,tck.create_time, eventos.value_date)<=sla.solution_time THEN 'Encerrado Dentro do Prazo'
  WHEN disc.id=9 AND TIMESTAMPDIFF(MINUTE,tck.create_time, ts.data_encerramento_ticket)<=sla.solution_time THEN 'Encerrado Dentro do Prazo'
  WHEN tempoatend.tempo_atendimento<=sla.solution_time  THEN 'Encerrado Dentro do Prazo'
  ELSE "Encerrado Fora do Prazo"
END AS "Status Encerramento Chamado",

SUBSTRING(SUBSTRING_INDEX(SUBSTRING_INDEX(serv.name, '::', 4), '::', -1), 9, 20) AS "Tipo Serviço",
SUBSTRING_INDEX(SUBSTRING_INDEX(serv.name, '::', 2), '::', -1) AS "Grupo",
SUBSTRING_INDEX(SUBSTRING_INDEX(serv.name, '::', 3), '::', -1) AS "Subgrpo",
SUBSTRING_INDEX(SUBSTRING_INDEX(serv.name, '::', 4), '::', -1) AS "Grupo Serviço",
SUBSTRING_INDEX(SUBSTRING_INDEX(serv.name, '::', 5), '::', -1) AS "Serviço Catálogo",
SUBSTRING_INDEX(SUBSTRING_INDEX(serv.name, '::', 1), '::', -1) AS "Disciplina",
tck.title AS "Titulo Chamado",
dfvslamudanca.value_text AS "Status da Mudança",
sttck.name AS "Estado Chamado",
q.name AS "Fila",
CASE
  WHEN q.id in (9,13) THEN 'Atendimento N1'
  WHEN q.id in (24,26) THEN 'Serviços de Terceiros'
  WHEN q.id in (10,11,12) THEN 'Atendimento N2'
  ELSE q.name
END as Torre, 
filaresponsavel.filaresponsavel AS "Fila Responsável",
CASE
  WHEN disc.id=7 THEN  eventos.value_date 
  ELSE ts.data_encerramento_ticket
END AS "Data/Hora de Encerramento",

CASE
  WHEN disc.id IN (8,13) AND ts.data_classificacao_ticket IS NULL THEN '1 - Até 10 Min'
  WHEN disc.id IN (8,13) AND ts.data_classificacao_ticket IS NOT NULL 
  AND TIMESTAMPDIFF(MINUTE,tck.create_time, ts.data_classificacao_ticket) < 11 THEN '1 - Até 10 Min'
  WHEN disc.id IN (8,13) AND  ts.data_classificacao_ticket IS NOT NULL 
  AND TIMESTAMPDIFF(MINUTE,tck.create_time, ts.data_classificacao_ticket) < 31 THEN '2 - Até 30 Min'
  WHEN disc.id IN (8,13) AND  ts.data_classificacao_ticket IS NOT NULL 
  AND TIMESTAMPDIFF(MINUTE,tck.create_time, ts.data_classificacao_ticket) > 30 THEN '3 - Acima 30 Min'
  ELSE NULL
END AS 'Tempo_Classificacao',

CASE
    WHEN (disc.id=7 and TIMESTAMPDIFF(MINUTE,tck.create_time, eventos.value_date) < 61) OR 
	 (disc.id=9 and TIMESTAMPDIFF(MINUTE,tck.create_time, ts.data_encerramento_ticket) < 61) OR 
	 tempoatend.tempo_atendimento < 61 THEN '1 - Até 1 Hora'
	 WHEN (disc.id=7 and TIMESTAMPDIFF(MINUTE,tck.create_time, eventos.value_date) < 121) OR 
	 (disc.id=9 and TIMESTAMPDIFF(MINUTE,tck.create_time, ts.data_encerramento_ticket) < 121) OR
	 tempoatend.tempo_atendimento < 121 THEN '2 - Entre 1  e 2 horas'
    WHEN (disc.id=7 and TIMESTAMPDIFF(MINUTE,tck.create_time, eventos.value_date) < 181) OR 
	 (disc.id=9 and TIMESTAMPDIFF(MINUTE,tck.create_time, ts.data_encerramento_ticket) < 181) OR
	 tempoatend.tempo_atendimento < 181 THEN '3 - Entre 2 e 3 horas'
    WHEN (disc.id=7 and TIMESTAMPDIFF(MINUTE,tck.create_time, eventos.value_date) < 241) OR 
	 (disc.id=9 and TIMESTAMPDIFF(MINUTE,tck.create_time, ts.data_encerramento_ticket) < 241) OR 
	 tempoatend.tempo_atendimento < 241 THEN '4 - Entre 3 e 4 Horas'
    ELSE '5 - Acima de 4 Horas'
END AS 'Tempo_Atendimento_calculado_restrito',

CASE
    WHEN disc.id IN (8,13) AND ts.data_classificacao_ticket IS NULL THEN '1 - Até 10 Min'
  WHEN disc.id IN (8,13) AND ts.data_classificacao_ticket IS NOT NULL 
  AND TIMESTAMPDIFF(MINUTE,tck.create_time, ts.data_classificacao_ticket) < 11 THEN '1 - Até 10 Min'
   ELSE '2 - Acima de 10 Min'
END AS 'Tempo_Classificacao_10min',

CASE
    WHEN disc.id IN (8,13) AND tempoatend.tempo_atendimento < 11 THEN '1 - Até 10 Min'
    ELSE '2 - Acima de 10 Min'
END AS 'Tempo_Atendimento_10min',



CASE
     WHEN DATE_FORMAT(tck.create_time,'%H') < 8 THEN '01 - Antes da 8 horas'
     WHEN DATE_FORMAT(tck.create_time,'%H') < 9 THEN '02 - Entre 8 e 9 horas'
     WHEN DATE_FORMAT(tck.create_time,'%H') < 10 THEN '03 - Entre 9 e 10 horas'
     WHEN DATE_FORMAT(tck.create_time,'%H') < 11 THEN '04 - Entre 10 e 11 horas'
     WHEN DATE_FORMAT(tck.create_time,'%H') < 12 THEN '05 - Entre 11 e 12 horas'
     WHEN DATE_FORMAT(tck.create_time,'%H') < 13 THEN '06 - Entre 12 e 13 horas'
     WHEN DATE_FORMAT(tck.create_time,'%H') < 14 THEN '07 - Entre 13 e 14 horas'
     WHEN DATE_FORMAT(tck.create_time,'%H') < 15 THEN '08 - Entre 14 e 15 horas'
     WHEN DATE_FORMAT(tck.create_time,'%H') < 16 THEN '09 - Entre 15 e 16 horas'
     WHEN DATE_FORMAT(tck.create_time,'%H') < 17 THEN '10 - Entre 16 e 17 horas'
     WHEN DATE_FORMAT(tck.create_time,'%H') < 18 THEN '11 - Entre 17 e 18 horas'
     WHEN DATE_FORMAT(tck.create_time,'%H') < 19 THEN '12 - Entre 18 e 19 horas'
     WHEN DATE_FORMAT(tck.create_time,'%H') < 20 THEN '13 - Entre 19 e 20 horas'
     WHEN DATE_FORMAT(tck.create_time,'%H') >= 20 THEN '14 - Depois das 20 horas'
END AS "Horario Criacao Chamado",
CASE
     WHEN DATE_FORMAT(ts.data_encerramento_ticket,'%H') < 8 THEN '01 - Antes da 8 horas'
     WHEN DATE_FORMAT(ts.data_encerramento_ticket,'%H') < 9 THEN '02 - Entre 8 e 9 horas'
     WHEN DATE_FORMAT(ts.data_encerramento_ticket,'%H') < 10 THEN '03 - Entre 9 e 10 horas'
     WHEN DATE_FORMAT(ts.data_encerramento_ticket,'%H') < 11 THEN '04 - Entre 10 e 11 horas'
     WHEN DATE_FORMAT(ts.data_encerramento_ticket,'%H') < 12 THEN '05 - Entre 11 e 12 horas'
     WHEN DATE_FORMAT(ts.data_encerramento_ticket,'%H') < 13 THEN '06 - Entre 12 e 13 horas'
     WHEN DATE_FORMAT(ts.data_encerramento_ticket,'%H') < 14 THEN '07 - Entre 13 e 14 horas'
     WHEN DATE_FORMAT(ts.data_encerramento_ticket,'%H') < 15 THEN '08 - Entre 14 e 15 horas'
     WHEN DATE_FORMAT(ts.data_encerramento_ticket,'%H') < 16 THEN '09 - Entre 15 e 16 horas'
     WHEN DATE_FORMAT(ts.data_encerramento_ticket,'%H') < 17 THEN '10 - Entre 16 e 17 horas'
     WHEN DATE_FORMAT(ts.data_encerramento_ticket,'%H') < 18 THEN '11 - Entre 17 e 18 horas'
     WHEN DATE_FORMAT(ts.data_encerramento_ticket,'%H') < 19 THEN '12 - Entre 18 e 19 horas'
     WHEN DATE_FORMAT(ts.data_encerramento_ticket,'%H') < 20 THEN '13 - Entre 19 e 20 horas'
     WHEN DATE_FORMAT(ts.data_encerramento_ticket,'%H') >= 20 THEN '14 - Depois das 20 horas'
END AS "Horario Encerramento Chamado", 

CASE
  WHEN associacao.id IS NOT NULL THEN 'Com Vínculo' 
  ELSE 'Sem Vínculo'  
END AS "Associado",

CASE
  WHEN setor.setor IS NOT NULL THEN setor.setor 
  ELSE 'DESCONHECIDO'  
END AS "Setor",

solicitante.solicitante AS Solicitante,

CASE
     WHEN  reab.ticket_id IS NOT NULL THEN 'REABERTO'
	  ELSE 'SEM REABERTURA'
END AS "Statu de Reabertura de chamado",

subpend1.name AS textopendencia,
CASE
  	WHEN dfvtempoespera.value_text IS NULL OR dfvtempoespera.value_text < 0 THEN 0
  	ELSE dfvtempoespera.value_text
END AS "Tempo de Espera",

CASE
  	WHEN subpend1.name IN('%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Usuário',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Usuário',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%Pendência de Usuário',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%Pendência de Usuário',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%NA',
	'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Fornecedor',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%NA',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%Pendência de Fornecedor',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%Pendência de Fornecedor',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Fornecedor',
	'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Mudança',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Mudança',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%NA',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Mudança',
	'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Laboratório',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Laboratório',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%NA',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Laboratório',
	'%%FieldName%%PMMotivoPendencia%%Value%%Aguardando Conclusão de Comando%%OldValue%%',
	'%%FieldName%%PMMotivoPendencia%%Value%%NA%%OldValue%%Aguardando Conclusão de Comando',
	'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência')
	THEN 'Sim'
  	ELSE 'Não'
END AS "Houve Pendência",
CASE
  	WHEN 
  	subpend1.name IN('%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Usuário',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Usuário',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%Pendência de Usuário',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%Pendência de Usuário',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%NA')
  	THEN 'Pendência de Usuário'
  
  	WHEN subpend1.name IN(
	'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Fornecedor',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%NA',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%Pendência de Fornecedor',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%Pendência de Fornecedor',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Fornecedor')
	THEN 'Pendência de Fornecedor'
  	
  	WHEN subpend1.name IN(
	'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Mudança',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Mudança',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%NA',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Mudança')
	THEN 'Pendência de Mudança'
	
  	WHEN subpend1.name IN(
	'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Laboratório',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Laboratório',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%NA',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Laboratório')
  	THEN 'Pendência de Laboratório'
  
   WHEN subpend1.name IN(
	'%%FieldName%%PMMotivoPendencia%%Value%%Aguardando Conclusão de Comando%%OldValue%%',
	'%%FieldName%%PMMotivoPendencia%%Value%%NA%%OldValue%%Aguardando Conclusão de Comando')
	THEN 'Aguardando Conclusão de Comando'
  
  
	WHEN subpend1.name IN('%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência')
	THEN 'Pendência de Problema'
     
 	ELSE 'NÃO HOUVE PENDÊNCIA'
END AS "Tipo de Pendência"

FROM otrs.ticket tck
LEFT JOIN otrs.service serv ON tck.service_id=serv.id
LEFT JOIN otrs.service_sla servsla ON servsla.service_id=serv.id
LEFT JOIN otrs.sla sla ON sla.id=servsla.sla_id
LEFT JOIN otrs.ticket_solutiontime ts ON tck.id=ts.ticket_id
LEFT JOIN otrs.users us on us.id=tck.user_id
LEFT JOIN otrs.ticket_type disc ON disc.id=tck.type_id
LEFT JOIN otrs.ticket_state sttck ON sttck.id=tck.ticket_state_id
LEFT JOIN otrs.queue q ON q.id=tck.queue_id
LEFT JOIN 
	(SELECT distinct spr.service_id, spr.preferences_value,
	CASE
	WHEN spr.preferences_value IN ('0 - Central de Serviço::Remoto', 
	'1 - Suporte::Técnico Remoto') THEN 'Atendimento N1'
	
	WHEN spr.preferences_value IN ('1 - Suporte::Técnico Local',
	'1 - Suporte::Avançado Local','1 - Suporte::Avançado Remoto')
	THEN 'Atendimento N2'
	ELSE spr.preferences_value
	END AS filaresponsavel
	from otrs.service_preferences spr
	where preferences_key = 'Queue') 
	filaresponsavel ON filaresponsavel.service_id=serv.id

LEFT JOIN 
	(SELECT 
	tck.id
	FROM otrs.ticket tck 
	LEFT JOIN otrs.ticket_solutiontime ts ON tck.id=ts.ticket_id
	LEFT JOIN  otrs.link_relation lh ON lh.target_key=tck.id
	LEFT JOIN otrs.configitem_history ch ON ch.id=lh.source_key
	LEFT JOIN otrs.configitem c ON c.id = ch.id
	LEFT JOIN otrs.configitem_version cv ON cv.configitem_id=c.id
	where lh.type_id=4 AND DATE_FORMAT(ts.data_encerramento_ticket, '%Y-%m')>='2022-12'
	GROUP BY tck.id
	) associacao ON associacao.id=tck.id
	
/*
LEFT JOIN 
	(SELECT 
	d.object_id,
   d.value_text
	from otrs.dynamic_field_value d
	where field_id = 66) dfvtempoatend ON dfvtempoatend.object_id=tck.id
*/


LEFT JOIN 
	(SELECT 
	d.object_id,
   d.value_text AS setor
	from otrs.dynamic_field_value d
	where field_id = 17) setor ON setor.object_id=tck.id
	
LEFT JOIN ( 
	SELECT d.object_id,
	d.value_text AS solicitante
	from otrs.dynamic_field_value d
	where field_id = 83) solicitante ON solicitante.object_id=tck.id

LEFT JOIN 
	(SELECT 
	d.object_id,
   d.value_text
	from otrs.dynamic_field_value d
	where field_id = 39) dfvslamudanca ON dfvslamudanca.object_id=tck.id
/*	
LEFT JOIN 
	(SELECT 
	d.object_id,
   d.value_text
	from otrs.dynamic_field_value d
	where field_id = 64) dfvslaencerramento ON dfvslaencerramento.object_id=tck.id	
*/
LEFT JOIN 
	(SELECT 
	d.object_id,
   d.value_text,
   d.value_date
	from otrs.dynamic_field_value d
	 where d.field_id = 56) eventos ON eventos.object_id=tck.id

LEFT JOIN 
	(select the.ticket_id, 
	    round(if(sum(interval_time)>0, sum(interval_time)/60,0)) as tempo_atendimento 
	from otrs.ticket_history_events the
	where the.prev_state_id in (select id from otrs.ticket_state where name regexp 'Aberto|Em Atendimento|Executando|Investigando|Reaberto|Encaminhado')  
	and history_type_id = 27 -- and the.ticket_id = 137205
	group by the.ticket_id
	order by the.ticket_id 
	) tempoatend ON tempoatend.ticket_id=tck.id

 
LEFT JOIN 
	(
	SELECT T.id,
	    convert(UP.preferences_value using utf8) as origem,
	    CASE THT.name
	        WHEN 'PhoneCallCustomer' THEN 
	            if ( convert(UP.preferences_value using utf8) regexp 'Nível 1', 'ABERTURA VIA 0800', 'ABERTURA VIA TECNICO')
	        WHEN 'WebRequestCustomer' THEN 'ABERTURA VIA WEB'
	        WHEN 'SystemRequest'THEN 
	            IF(  U.login regexp "healthcheck",  'ABERTURA VIA SAÚDE OPERACIONAL', 'ABERTURA VIA API')
	        WHEN 'NewTicket'THEN
	            IF(  U.login regexp "healthcheck",  'ABERTURA VIA SAÚDE OPERACIONAL', 'ABERTURA VIA API')
	        WHEN 'EmailAgent' THEN 'ABERTURA VIA TECNICO'
	        WHEN 'EmailCustomer' THEN 'ABERTURA VIA EMAIL'
	        ELSE 'DESCONHECIDO'
	    END as tipo_chamado
	    FROM otrs.ticket_history TH
	inner join otrs.ticket_history_type THT on THT.id = TH.history_type_id
	inner join otrs.ticket T on T.id = TH.ticket_id
	LEFT JOIN otrs.ticket_solutiontime ts ON T.id=ts.ticket_id    
	inner join otrs.users U on U.id = T.create_by
	inner join otrs.user_preferences UP on UP.user_id = U.id
	inner join (select min(id) as TicketHistoryId, ticket_id from otrs.ticket_history where article_id is not null group by ticket_id) as TH1 on TH.id = TH1.TicketHistoryId
	where 
	THT.name not regexp 'Follow' and UP.preferences_key = 'UserArea'
	AND ts.data_encerramento_ticket>='2022-12-01 00:00:00'
	group BY T.id, origem, tipo_chamado
	) tipochamado ON tipochamado.id = tck.id
    
LEFT JOIN 
	(	SELECT th.ticket_id
		FROM otrs.ticket_history th 
		LEFT JOIN otrs.ticket_history_events the ON the.ticket_history_id=th.id
		INNER JOIN 
		(
		SELECT th.ticket_id, max(th.create_time) AS ultdata
		FROM otrs.ticket_history th 
		INNER JOIN otrs.ticket_history_events the ON th.id=the.ticket_history_id 
		WHERE the.name = '%%Reaberto%%Em Atendimento%%' -- AND th.ticket_id=137742
		GROUP BY th.ticket_id
		) sub ON sub.ticket_id=th.ticket_id AND th.create_time=sub.ultdata
		WHERE the.name = '%%Reaberto%%Em Atendimento%%'
	) reab ON reab.ticket_id=tck.id


LEFT JOIN (
SELECT 
	tck.id,
	th.name
	FROM otrs.ticket tck
	LEFT JOIN otrs.ticket_type disc ON disc.id=tck.type_id
	LEFT JOIN otrs.ticket_history th ON th.ticket_id=tck.id
	
INNER JOIN (
	SELECT 
	tck.id,
	MAX(th.create_time) ultimapendencia
	FROM otrs.ticket tck
	LEFT JOIN otrs.ticket_type disc ON disc.id=tck.type_id
	LEFT JOIN otrs.ticket_history th ON th.ticket_id=tck.id
	WHERE th.name IN  
(
'%%FieldName%%PMMotivoPendencia%%Value%%Aguardando Conclusão de Comando%%OldValue%%',
'%%FieldName%%PMMotivoPendencia%%Value%%NA%%OldValue%%Aguardando Conclusão de Comando',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Fornecedor',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Laboratório',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Mudança',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Usuário',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%NA',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Laboratório',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Mudança',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Usuário',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%NA',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%Pendência de Fornecedor',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%Pendência de Usuário',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%NA',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%Pendência de Fornecedor',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%Pendência de Usuário',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%NA',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Fornecedor',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Laboratório',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Mudança'
)
	GROUP BY tck.id
	) subpend ON subpend.id=tck.id AND subpend.ultimapendencia=th.create_time

WHERE th.name IN  
(
'%%FieldName%%PMMotivoPendencia%%Value%%Aguardando Conclusão de Comando%%OldValue%%',
'%%FieldName%%PMMotivoPendencia%%Value%%NA%%OldValue%%Aguardando Conclusão de Comando',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Fornecedor',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Laboratório',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Mudança',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Usuário',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%NA',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Laboratório',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Mudança',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Usuário',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%NA',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%Pendência de Fornecedor',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%Pendência de Usuário',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%NA',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%Pendência de Fornecedor',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%Pendência de Usuário',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%NA',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Fornecedor',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Laboratório',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Mudança'
)
)subpend1 ON subpend1.id=tck.id

LEFT JOIN 
	(SELECT 
	d.object_id,
   d.value_text
	from otrs.dynamic_field_value d
	where field_id = 67) dfvtempoespera ON dfvtempoespera.object_id=tck.id

WHERE
disc.id IN (7,8,9,10,11,12,13,16)
AND sttck.id IN (20,21,22,24,25,26,34,36,37)
AND tck.queue_id NOT IN (23,24,25,26,27,28,29,30)
-- ts.data_encerramento_ticket IS not NULL 
-- AND sttck.name NOT IN ('Cancelado', 'Aguardando Cancelamento','Concluido com Sucesso')
-- AND (ts.data_encerramento_ticket >='2023-01-01 00:00:00' OR eventos.value_date >='2023-01-01 00:00:00')
AND (DATE_FORMAT(ts.data_encerramento_ticket, '%Y-%m')>='2022-12' or DATE_FORMAT(eventos.value_date, '%Y-%m')>='2022-12')
;



chamados_abertos:
SQL
SELECT
 DATE_FORMAT(tck.create_time, '%Y-%m') AS "Período",
-- tck.id idtckpendencia,
tck.tn AS "Numero Chamado Abertura",
tck.create_time AS "Data/Hora de Criacao Abertura",
ts.data_classificacao_ticket AS "Data Classificação Abertura",
ts.data_encerramento_ticket as "Data Encerramento Abertura",
CASE  -- Tem necessidade de pegar o tempo no item do catálogo
  WHEN tck.create_time>='2023-02-04 00:00:00' THEN 'Novo'
  ELSE 'Antigo'
END AS "Tipo SLA Abertos",
tipochamado.origem AS "Origem da Abertura Abertos",
tipochamado.tipo_chamado AS "Meio de Abertura Abertos",

CASE -- Tem necessidade de pegar o tempo no item do catálogo
  WHEN (TIMESTAMPDIFF(MINUTE,tck.create_time, ts.data_classificacao_ticket)<=sla.comments AND disc.id IN (8,13))
  OR (ts.data_classificacao_ticket is NULL AND disc.id IN (8,13)) 
  THEN "Classificado Dentro do Prazo"
  WHEN (TIMESTAMPDIFF(MINUTE,tck.create_time, ts.data_solutiontime_ticket)>sla.comments AND disc.id IN (8,13))
  THEN "Classificado Fora do Prazo"
  ELSE 'INDETERMINADO'
END AS "Status Classificacao Chamado Abertura",

CASE  -- Tem necessidade de pegar o tempo no item do catálogo
  WHEN sla.comments <= 10 then 'Crítico'
  ELSE 'Não Crítico'
END AS "Criticidade Abertura", 

SUBSTRING_INDEX(SUBSTRING_INDEX(serv.name, '::', 2), '::', -1) AS "Grupo Abertura",
SUBSTRING_INDEX(SUBSTRING_INDEX(serv.name, '::', 3), '::', -1) AS "Nome Abertura",
SUBSTRING_INDEX(SUBSTRING_INDEX(serv.name, '::', 4), '::', -1) AS "Descrição Abertura",
SUBSTRING_INDEX(SUBSTRING_INDEX(serv.name, '::', 5), '::', -1) AS "Serviço Abertura",
SUBSTRING_INDEX(SUBSTRING_INDEX(serv.name, '::', 1), '::', -1) AS "Disciplina Abertura",
tck.title AS "Titulo Chamado Abertura",
sttck.name AS "Estado Chamado Abertura",
q.name AS "Fila Abertura",
TIMESTAMPDIFF(MINUTE,tck.create_time, ts.data_classificacao_ticket) AS "Tempo Classificação (Min) Abertura",
sla.comments AS "SLA Classificação Abertura"
FROM otrs.ticket tck
LEFT JOIN otrs.service serv ON tck.service_id=serv.id
LEFT JOIN otrs.service_sla servsla ON servsla.service_id=serv.id
LEFT JOIN otrs.sla sla ON sla.id=servsla.sla_id
LEFT JOIN otrs.ticket_solutiontime ts ON tck.id=ts.ticket_id
LEFT JOIN otrs.ticket_type disc ON disc.id=tck.type_id
LEFT JOIN otrs.ticket_state sttck ON sttck.id=tck.ticket_state_id
LEFT JOIN otrs.queue q ON q.id=tck.queue_id
LEFT JOIN 
	(
	SELECT T.id,
	    convert(UP.preferences_value using utf8) as origem,
	    CASE THT.name
	        WHEN 'PhoneCallCustomer' THEN 
	            if ( convert(UP.preferences_value using utf8) regexp 'Nível 1', 'ABERTURA VIA 0800', 'ABERTURA VIA TECNICO')
	        WHEN 'WebRequestCustomer' THEN 'ABERTURA VIA WEB'
	        WHEN 'SystemRequest'THEN 
	            IF(  U.login regexp "healthcheck",  'ABERTURA VIA SAÚDE OPERACIONAL', 'ABERTURA VIA API')
	        WHEN 'NewTicket'THEN
	            IF(  U.login regexp "healthcheck",  'ABERTURA VIA SAÚDE OPERACIONAL', 'ABERTURA VIA API')
	        WHEN 'EmailAgent' THEN 'ABERTURA VIA TECNICO'
	        WHEN 'EmailCustomer' THEN 'ABERTURA VIA EMAIL'
	        ELSE 'DESCONHECIDO'
	    END as tipo_chamado
	    FROM otrs.ticket_history TH
	inner join otrs.ticket_history_type THT on THT.id = TH.history_type_id
	inner join otrs.ticket T on T.id = TH.ticket_id
	LEFT JOIN otrs.ticket_solutiontime ts ON T.id=ts.ticket_id    
	inner join otrs.users U on U.id = T.create_by
	inner join otrs.user_preferences UP on UP.user_id = U.id
	inner join (select min(id) as TicketHistoryId, ticket_id from otrs.ticket_history where article_id is not null group by ticket_id) as TH1 on TH.id = TH1.TicketHistoryId
	where 
	THT.name not regexp 'Follow' and UP.preferences_key = 'UserArea'
	AND ts.data_encerramento_ticket>='2022-12-01 00:00:00'
	group BY T.id, origem, tipo_chamado
	) tipochamado ON tipochamado.id = tck.id
WHERE
disc.id IN (8,13) 
AND tck.queue_id NOT IN (23,24,25,26,27,28,29,30)
AND sttck.name NOT IN ('Cancelado', 'Aguardando Cancelamento')
AND DATE_FORMAT(tck.create_time, '%Y-%m')>='2022-12'
;


Pesquisa:
SQL
SELECT 
DATE_FORMAT(sr.vote_time, '%Y-%m') AS "Período",
tck.tn AS "Chamado", 
sr.id AS "Numero da Pesquisa",
tck.title "Título",
tck.create_time "Data Abertura Chamado",
sr.vote_time"Data Votação",
sq.question AS "Pergunta",
sa.answer "Resposta",
solicitante.solicitante AS "Votante",

CASE
  WHEN sv.vote_value=1  THEN 'Pesquisas Positivas'
  WHEN sv.vote_value=2  THEN 'Pesquisas Positivas'
  WHEN sv.vote_value=3  THEN 'Parcialmente Satisfeito'
  WHEN sv.vote_value=4  THEN 'Pesquisas Negativas'
  WHEN sv.vote_value=5  THEN 'Pesquisas Negativas'  
  ELSE NULL 
END AS "Classificacao da Pesquisa",
CASE
  WHEN sv.vote_value=1  THEN 5
  WHEN sv.vote_value=2  THEN 4
  WHEN sv.vote_value=3  THEN 3
  WHEN sv.vote_value=4  THEN 2
  WHEN sv.vote_value=5  THEN 1  
  ELSE 0
END AS "Valor Votado"

FROM 
otrs.survey_request sr 
LEFT JOIN otrs.ticket tck ON tck.id = sr.ticket_id
LEFT JOIN otrs.survey_question sq ON sq.survey_id=sr.survey_id AND sq.id=1
LEFT JOIN otrs.survey_vote sv ON sv.request_id=sr.id
LEFT JOIN otrs.survey_answer sa ON sa.id=sv.vote_value
LEFT JOIN ( 
	SELECT d.object_id,
	d.value_text AS solicitante
	from otrs.dynamic_field_value d
	where field_id = 83) solicitante ON solicitante.object_id=tck.id
WHERE sr.vote_time IS NOT NULL AND sv.question_id=1
AND DATE_FORMAT(sr.vote_time, '%Y-%m')>='2022-12'
;



Pendencias:
SQL
SELECT
DATE_FORMAT(tck.create_time, '%Y-%m') AS "Período",
tck.id idtckpendencia,
tck.tn as chamadopendencia,
tck.create_time AS datacriacaochamadopendencia,
SUBSTRING_INDEX(SUBSTRING_INDEX(serv.name, '::', 2), '::', -1) AS "Grupo Pendência Abertos",
SUBSTRING_INDEX(SUBSTRING_INDEX(serv.name, '::', 3), '::', -1) AS "Nome Pendência Abertos",
SUBSTRING_INDEX(SUBSTRING_INDEX(serv.name, '::', 4), '::', -1) AS "Descrição Pendência Abertos",
SUBSTRING_INDEX(SUBSTRING_INDEX(serv.name, '::', 5), '::', -1) AS "Serviço Pendência Abertos",
SUBSTRING_INDEX(SUBSTRING_INDEX(serv.name, '::', 1), '::', -1) AS "Disciplina Pendência Abertos",
us.login as atendentependencia,
us.title as emailatendentependencia,
tck.title as titulochamadopendencia,
art_mine.a_body as comentariopendencia,
art.create_time as datacriacaopendencia,
ts.data_encerramento_ticket dataencerramento,
sttck.name AS tipo_pendencia,

subpend1.name AS textopendenciaaberta,

CASE
  	WHEN 
  	subpend1.name IN('%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Usuário',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Usuário',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%Pendência de Usuário',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%Pendência de Usuário',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%NA')
  	THEN 'Pendência de Usuário'
  
  	WHEN subpend1.name IN(
	'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Fornecedor',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%NA',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%Pendência de Fornecedor',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%Pendência de Fornecedor',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Fornecedor')
	THEN 'Pendência de Fornecedor'
  	
  	WHEN subpend1.name IN(
	'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Mudança',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Mudança',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%NA',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Mudança')
	THEN 'Pendência de Mudança'
	
  	WHEN subpend1.name IN(
	'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Laboratório',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Laboratório',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%NA',
	'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Laboratório')
  	THEN 'Pendência de Laboratório'
  
   WHEN subpend1.name IN(
	'%%FieldName%%PMMotivoPendencia%%Value%%Aguardando Conclusão de Comando%%OldValue%%',
	'%%FieldName%%PMMotivoPendencia%%Value%%NA%%OldValue%%Aguardando Conclusão de Comando')
	THEN 'Aguardando Conclusão de Comando'
  
  
	WHEN subpend1.name IN('%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência')
	THEN 'Pendência de Problema'
     
 	ELSE 'NÃO HOUVE PENDÊNCIA'
END AS "Tipo de Pendência Aberta",

TIMESTAMPDIFF(MINUTE,tck.create_time, NOW()) as tempodecorrido,
CASE
WHEN TIMESTAMPDIFF(MINUTE,tck.create_time, NOW()) <= 1440 THEN '1 - Menos de 1 dia'
WHEN TIMESTAMPDIFF(MINUTE,tck.create_time, NOW()) > 1440 AND TIMESTAMPDIFF(MINUTE,tck.create_time, NOW()) <= 2880 THEN '2 - Menos de 2 dias'
WHEN TIMESTAMPDIFF(MINUTE,tck.create_time, NOW()) >2880 AND TIMESTAMPDIFF(MINUTE,tck.create_time, NOW()) <= 10080 THEN '3 - Menos de 1 semana'
WHEN TIMESTAMPDIFF(MINUTE,tck.create_time, NOW()) > 10080 AND TIMESTAMPDIFF(MINUTE,tck.create_time, NOW()) <= 43200 THEN '4 - Menos de mês'
ELSE '5 - Mais de 1 Mês'
END AS 'Tempo_Pendencia'


FROM otrs.ticket tck
LEFT JOIN otrs.service serv ON tck.service_id=serv.id
LEFT JOIN otrs.ticket_solutiontime ts ON tck.id=ts.ticket_id
LEFT JOIN otrs.users us on us.id=tck.user_id
LEFT JOIN otrs.ticket_type disc ON disc.id=tck.type_id
LEFT JOIN otrs.ticket_state sttck ON sttck.id=tck.ticket_state_id


LEFT JOIN (
SELECT 
	tck.id,
	th.name
	FROM otrs.ticket tck
	LEFT JOIN otrs.ticket_type disc ON disc.id=tck.type_id
	LEFT JOIN otrs.ticket_history th ON th.ticket_id=tck.id
	
INNER JOIN (
	SELECT 
	tck.id,
	MAX(th.create_time) ultimapendencia
	FROM otrs.ticket tck
	LEFT JOIN otrs.ticket_type disc ON disc.id=tck.type_id
	LEFT JOIN otrs.ticket_history th ON th.ticket_id=tck.id
	WHERE th.name IN  
(
'%%FieldName%%PMMotivoPendencia%%Value%%Aguardando Conclusão de Comando%%OldValue%%',
'%%FieldName%%PMMotivoPendencia%%Value%%NA%%OldValue%%Aguardando Conclusão de Comando',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Fornecedor',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Laboratório',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Mudança',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Usuário',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%NA',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Laboratório',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Mudança',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Usuário',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%NA',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%Pendência de Fornecedor',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%Pendência de Usuário',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%NA',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%Pendência de Fornecedor',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%Pendência de Usuário',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%NA',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Fornecedor',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Laboratório',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Mudança'
)
	GROUP BY tck.id
	) subpend ON subpend.id=tck.id AND subpend.ultimapendencia=th.create_time


WHERE th.name IN  
(
'%%FieldName%%PMMotivoPendencia%%Value%%Aguardando Conclusão de Comando%%OldValue%%',
'%%FieldName%%PMMotivoPendencia%%Value%%NA%%OldValue%%Aguardando Conclusão de Comando',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Fornecedor',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Laboratório',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Mudança',
'%%FieldName%%PRIMotivoPendencia%%Value%%NA%%OldValue%%Pendência de Usuário',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%NA',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Laboratório',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Mudança',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Fornecedor%%OldValue%%Pendência de Usuário',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%NA',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%Pendência de Fornecedor',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Laboratório%%OldValue%%Pendência de Usuário',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%NA',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%Pendência de Fornecedor',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Mudança%%OldValue%%Pendência de Usuário',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%NA',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Fornecedor',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Laboratório',
'%%FieldName%%PRIMotivoPendencia%%Value%%Pendência de Usuário%%OldValue%%Pendência de Mudança'
)
)subpend1 ON subpend1.id=tck.id



INNER JOIN otrs.article art ON art.ticket_id=tck.id
INNER JOIN otrs.article_data_mime art_mine ON art_mine.article_id=art.id
INNER JOIN (
SELECT ticket_id, MAX(create_time) AS ultcom
FROM otrs.article
where article_sender_type_id IN (1,3)
GROUP BY ticket_id) subart1 ON art.ticket_id=subart1.ticket_id AND art.create_time=subart1.ultcom



INNER JOIN
(
SELECT art_mine.article_id, MAX(art_mine.create_time) ultcom
FROM otrs.article art
INNER JOIN otrs.article_data_mime art_mine ON art_mine.article_id=art.id
where art.article_sender_type_id IN (1,3)
GROUP BY art_mine.article_id) subart ON art_mine.article_id=subart.article_id AND art_mine.create_time=subart.ultcom

WHERE
disc.id IN (8,9,10,11,12,13)
AND sttck.name NOT IN ('Cancelado', 'Aguardando Cancelamento')
AND tck.create_time>='2023-02-06 00:00:00' AND ts.data_encerramento_ticket IS NULL 
AND tck.queue_id in
(
5,
6,
7,
8,
9,
10,
11,
12,
13,
14,
15,
16,
17,
18,
19,
20,
21,
22
)
-- ORDER BY tempodecorrido desc
;

Repasse:
SQL
SELECT 
DATE_FORMAT(t.create_time, '%Y-%m') AS "Período",
t.tn AS "Chamado Repasse",
t.create_time AS "Criação Repasse",
t.title AS "Título Repasse",
tso.data_classificacao_ticket AS "Classificação Repasse",
tso.data_solutiontime_ticket AS "Encerramento Repasse",
th.create_time AS "Repasse N2",
CASE
	WHEN tso.data_classificacao_ticket IS NOT NULL THEN
		TIMESTAMPDIFF(MINUTE,tso.data_classificacao_ticket,th.create_time)
	ELSE TIMESTAMPDIFF(MINUTE,t.create_time,th.create_time)
END  AS "Tempo Decorrido Repasse",
CASE
	WHEN tso.data_classificacao_ticket IS NOT NULL AND TIMESTAMPDIFF(MINUTE,tso.data_classificacao_ticket,th.create_time) < 16 
	THEN 'Repassado em até 15 Min'   
	WHEN tso.data_classificacao_ticket IS NOT NULL AND TIMESTAMPDIFF(MINUTE,tso.data_classificacao_ticket,th.create_time) < 31 
	THEN 'Repassado em até 30 Min'   
	WHEN tso.data_classificacao_ticket IS NOT NULL AND TIMESTAMPDIFF(MINUTE,tso.data_classificacao_ticket,th.create_time) < 46 
	THEN 'Repassado em até 45 Min'   
	WHEN tso.data_classificacao_ticket IS NOT NULL AND TIMESTAMPDIFF(MINUTE,tso.data_classificacao_ticket,th.create_time) < 61 
	THEN 'Repassado em até 60 Min'   
	
	WHEN tso.data_classificacao_ticket IS NULL AND TIMESTAMPDIFF(MINUTE,t.create_time,th.create_time) < 16 
	THEN 'Repassado em até 15 Min'   
	WHEN tso.data_classificacao_ticket IS NULL AND TIMESTAMPDIFF(MINUTE,t.create_time,th.create_time) < 31 
	THEN 'Repassado em até 30 Min'   
	WHEN tso.data_classificacao_ticket IS NULL AND TIMESTAMPDIFF(MINUTE,t.create_time,th.create_time) < 46 
	THEN 'Repassado em até 45 Min'   
	WHEN tso.data_classificacao_ticket IS NULL AND TIMESTAMPDIFF(MINUTE,t.create_time,th.create_time) < 61 
	THEN 'Repassado em até 60 Min'   
ELSE 'Repassado acima de 1 hora'
END AS "Classificação de repasse ao N1"
from ticket t
LEFT JOIN otrs.ticket_solutiontime tso ON t.id=tso.ticket_id
LEFT JOIN  ticket_history th ON th.ticket_id = t.id
INNER JOIN 
	(
	SELECT subth.ticket_id, MIN(subth.create_time) AS primeirorepasse
	FROM ticket_history subth
	WHERE 
	(subth.name like '%1 - Suporte::Técnico Local%' OR subth.name like '%1 - Suporte::Avançado Remotov%'
	OR subth.name like '%1 - Suporte::Avançado Local%')
	GROUP BY subth.ticket_id
	) subth1 ON subth1.ticket_id=th.ticket_id AND subth1.primeirorepasse=th.create_time
LEFT JOIN  ticket_type tt ON t.type_id = tt.id
LEFT JOIN  ticket_state ts ON t.ticket_state_id = ts.id

WHERE 
(th.name like '%1 - Suporte::Técnico Local%' OR th.name like '%1 - Suporte::Avançado Remotov%'
OR th.name like '%1 - Suporte::Avançado Local%') AND 
t.type_id IN (8,13) AND 
ts.name not in ('Aguardando Cancelamento','Cancelado','Descartado') AND 
t.create_time>='2023-02-06 00:00:00' 
AND tso.data_solutiontime_ticket IS NOT null
;

